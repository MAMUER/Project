<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/trainers.css}">
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap'>
    <title>Тренеры</title>
</head>

<body>
    <!-- Общий overlay для всех форм -->
    <div id="overlay"></div>

    <div class="sidebar">
        <div class="logo">
            <img th:src="@{/icons/logo.png}" alt="Logo">
        </div>

        <div class="icons">
            <th:block th:switch="${role}">
                <div th:case="'member'" class="icon-group">
                    <a class="profile" th:href="'/profile/member/' + ${memberId}">
                        <img th:src="@{/icons/profile.svg}" alt="Profile">
                    </a>
                    <a class="calendar" th:href="'/calendar/member/' + ${memberId}">
                        <img th:src="@{/icons/calendar.svg}" alt="Calendar">
                    </a>
                    <a class="statistic" th:href="'/statistic/member/' + ${memberId}">
                        <img th:src="@{/icons/statistic.svg}" alt="Statistic">
                    </a>
                    <a class="trainers" id="selected" th:href="'/trainers'">
                        <img th:src="@{/icons/programs.svg}" alt="Programs">
                    </a>
                    <a class="programs" th:href="'/programs/member/' + ${memberId}">
                        <img th:src="@{/icons/trainers.svg}" alt="trainers">
                    </a>
                </div>
            </th:block>
        </div>

        <div class="logout-container">
            <a class="logout" th:href="'/logout'">
                <img th:src="@{/icons/logout.svg}" alt="Log out">
            </a>
        </div>
    </div>

    <div class="content">
        <h1>Наши тренеры</h1>
        <div class="all-trainers">
            <div class="trainer-item" th:each="trainer, iter : ${trainers}">
                <div class="trainer-photo">
                    <img th:src="${trainer.trainersAccount?.trainersPhoto?.imageUrl ?: 'https://i.postimg.cc/Wbznd0qn/1674365371-3-34.jpg'}"
                        alt="Trainer Photo">
                </div>
                <div class="trainer-description">
                    <p class="trainer-name" th:text="${trainer.firstName} + ' ' + ${trainer.secondName}"></p>
                </div>
                <div class="buttons" th:if="${role == 'member'}">
                    <form th:action="'/trainers/subscribe'" method="post" th:object="${trainingRequest}"
                        class="subscribe-form">
                        <input type="hidden" name="trainerId" th:value="${trainer.idTrainer}">
                        <input type="hidden" name="memberId" th:value="${memberId}">
                        <input type="hidden" name="sessionDate" th:field="*{sessionDate}"
                            th:id="'date-select-' + ${iter.index}" />

                        <button type="button" class="openSidebar">Записаться</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div th:each="trainer, iter : ${trainers}" th:if="${role == 'member'}">
        <div class="trainer-sidebar" th:id="'sidebar-' + ${iter.index}">
            <h2>Выберите время тренировки</h2>
            <div class="registration">
                <input type="datetime-local" class="date" name="sessionDateInput"
                    th:id="'date-input-' + ${iter.index}" />
            </div>

            <div class="schedule">
                <h2>Занятость тренера</h2>
                <ul th:id="'scheduleList-' + ${iter.index}" class="scheduleList"></ul>
            </div>
            <button type="button" class="signup-button" th:data-form-index="${iter.index}"
                th:onclick="|submitForm(this)|">
                Записаться
            </button>

            <button type="button" class="closeSidebar">Закрыть</button>
        </div>
    </div>

    <script>
        async function submitForm(button) {
            // Получаем индекс формы из data-атрибута
            const formIndex = button.getAttribute('data-form-index');
            const form = document.querySelector(`#date-select-${formIndex}`).closest('.subscribe-form');

            if (!form) {
                console.error('Form not found for index:', formIndex);
                alert('Ошибка: форма не найдена');
                return;
            }

            // Проверяем доступность времени
            const isValid = await checkData(form);
            if (!isValid) {
                return;
            }

            // Обновляем скрытое поле sessionDate из видимого поля ввода
            const dateInput = document.querySelector(`#date-input-${formIndex}`);
            const hiddenDateField = form.querySelector('input[name="sessionDate"]');
            if (dateInput && hiddenDateField) {
                hiddenDateField.value = dateInput.value;
            }

            // Показываем подтверждение
            if (confirm('Вы уверены, что хотите записаться на тренировку?')) {
                // Отправляем форму
                form.submit();
            }
        }

        function formatTime(date) {
            let hours = date.getHours();
            let minutes = date.getMinutes();

            hours = hours < 10 ? '0' + hours : hours;
            minutes = minutes < 10 ? '0' + minutes : minutes;

            return hours + ':' + minutes;
        }

        function formatDateToYYYYMMDD(date) {
            let year = date.getFullYear();
            let month = date.getMonth() + 1;
            let day = date.getDate();

            month = month < 10 ? '0' + month : month;
            day = day < 10 ? '0' + day : day;

            return year + '-' + month + '-' + day;
        }

        function formatDateToDDMM(date) {
            let month = date.getMonth() + 1;
            let day = date.getDate();

            month = month < 10 ? '0' + month : month;
            day = day < 10 ? '0' + day : day;

            return day + '-' + month;
        }

        function setDateLimits(dateInput) {
            const now = new Date();
            const maxDate = new Date();
            maxDate.setMonth(now.getMonth() + 1); // Месяц вперед от текущей даты

            // Форматируем даты в правильном формате для input[datetime-local]
            dateInput.min = formatDateForInput(now);
            dateInput.max = formatDateForInput(maxDate);
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // ОБНОВИТЕ функцию fetchSchedule для работы с новым подходом
        function fetchSchedule(formIndex) {
            const form = document.querySelector(`#date-select-${formIndex}`).closest('.subscribe-form');
            if (!form) return;

            let trainerIdInput = form.querySelector('input[name="trainerId"]');
            let id_trainer = trainerIdInput ? trainerIdInput.value : '';

            // Проверяем, что ID тренера не пустой
            if (!id_trainer) {
                console.error('Trainer ID is empty');
                return;
            }

            let trainingDateInput = form.querySelector('input[name="sessionDate"]');

            if (!trainingDateInput || !trainingDateInput.value) {
                return;
            }

            let trainingDate = new Date(trainingDateInput.value);
            let dateStart = new Date(trainingDate.getFullYear(), trainingDate.getMonth(), trainingDate.getDate());
            let url = '/trainings?id_trainer=' + id_trainer
                + '&session_date_start=' + formatDateToYYYYMMDD(dateStart)
                + '&session_date_end=' + formatDateToYYYYMMDD(dateStart)
                + '&trainer_schedule=' + 1;

            console.log("Fetching schedule with URL:", url);

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => displaySchedule(data, formIndex))
                .catch(error => {
                    console.error('Error fetching schedule:', error);
                    // Показываем сообщение об ошибке пользователю
                    const scheduleList = document.querySelector(`#scheduleList-${formIndex}`);
                    if (scheduleList) {
                        scheduleList.innerHTML = '<li>Ошибка загрузки расписания</li>';
                    }
                });
        }

        function displaySchedule(schedule, formIndex) {
            const scheduleList = document.querySelector(`#scheduleList-${formIndex}`);
            if (!scheduleList) return;

            scheduleList.innerHTML = '';

            if (schedule.length === 0) {
                const listItem = document.createElement('li');
                listItem.textContent = 'Тренер свободен весь день';
                listItem.classList.add('free-day'); // ДОБАВЬТЕ ЭТУ СТРОЧКУ
                scheduleList.appendChild(listItem);
            } else {
                schedule.forEach(item => {
                    const listItem = document.createElement('li');
                    let startTime = formatTime(new Date(item.start));
                    let endTime = formatTime(new Date(item.end));
                    listItem.textContent = `${formatDateToDDMM(new Date(item.start))} с ${startTime} до ${endTime}`;
                    scheduleList.appendChild(listItem);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const forms = document.querySelectorAll('.subscribe-form');
            const overlay = document.getElementById('overlay');
            let currentSidebar = null;

            forms.forEach((form, index) => {
                let trainingDateField = form.querySelector('input[name="sessionDate"]');
                let openSidebarButton = form.querySelector('.openSidebar');
                let trainerSidebar = document.getElementById('sidebar-' + index);

                if (!trainerSidebar) return;

                let closeSidebarButton = trainerSidebar.querySelector('.closeSidebar');
                let dateInput = trainerSidebar.querySelector('input[type="datetime-local"]');

                // Устанавливаем ограничения даты при загрузке
                if (dateInput) {
                    setDateLimits(dateInput);
                }

                // Обработчик изменения даты
                if (trainingDateField) {
                    trainingDateField.addEventListener('change', function () {
                        fetchSchedule(index);
                    });
                }

                // Открытие sidebar
                if (openSidebarButton) {
                    openSidebarButton.addEventListener('click', function () {
                        if (currentSidebar) {
                            currentSidebar.classList.remove('active');
                        }

                        trainerSidebar.classList.add('active');
                        currentSidebar = trainerSidebar;

                        if (overlay) {
                            overlay.style.display = 'block';
                        }

                        // Устанавливаем дату по умолчанию если не установлена
                        if (trainingDateField && !trainingDateField.value) {
                            let now = new Date();
                            now.setMinutes(now.getMinutes() + 30);

                            // Проверяем, что дата не превышает максимальную
                            const maxDate = new Date();
                            maxDate.setMonth(maxDate.getMonth() + 1);

                            if (now.getTime() > maxDate.getTime()) {
                                now = new Date(maxDate); // Устанавливаем максимальную дату
                            }

                            trainingDateField.value = formatDateForInput(now);
                            fetchSchedule(index);
                        }

                        // Обновляем ограничения даты при каждом открытии
                        if (dateInput) {
                            setDateLimits(dateInput);
                        }
                    });
                }

                // Закрытие sidebar
                if (closeSidebarButton) {
                    closeSidebarButton.addEventListener('click', function () {
                        trainerSidebar.classList.remove('active');
                        currentSidebar = null;
                        if (overlay) overlay.style.display = 'none';
                    });
                }
            });

            // Закрытие по клику на overlay
            if (overlay) {
                overlay.addEventListener('click', function () {
                    if (currentSidebar) {
                        currentSidebar.classList.remove('active');
                        currentSidebar = null;
                    }
                    overlay.style.display = 'none';
                });
            }
        });

        async function checkData(form) {
            let trainerIdInput = form.querySelector('input[name="trainerId"]');
            let id_trainer = trainerIdInput ? trainerIdInput.value : '';

            if (!id_trainer) {
                alert('Ошибка: ID тренера не найден');
                return false;
            }

            var url = '/trainings?id_trainer=' + id_trainer + '&trainer_schedule=' + 1;

            let dateInput = form.querySelector('input[name="sessionDate"]');
            if (!dateInput || !dateInput.value) {
                alert('Пожалуйста, выберите дату и время тренировки');
                return false;
            }

            let newEventStart = new Date(dateInput.value);
            let newEventEnd = new Date(newEventStart.getTime() + 60 * 60000);

            // ПРАВИЛЬНОЕ сравнение дат - используем временную метку
            const now = new Date();
            const maxDate = new Date();
            maxDate.setMonth(now.getMonth() + 1);

            if (newEventStart.getTime() < now.getTime()) {
                alert("Нельзя записаться на прошедшую дату");
                return false;
            }

            if (newEventStart.getTime() > maxDate.getTime()) {
                alert("Запись возможна только на ближайший месяц");
                return false;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                for (let event of data) {
                    let eventStart = new Date(event.start);
                    let eventEnd = new Date(event.end);

                    if ((newEventStart >= eventStart && newEventStart < eventEnd) ||
                        (newEventEnd > eventStart && newEventEnd <= eventEnd) ||
                        (newEventStart <= eventStart && newEventEnd >= eventEnd)) {
                        alert("Тренировка пересекается с существующей занятостью тренера");
                        return false;
                    }
                }

                return true;

            } catch (error) {
                console.error('Error:', error);
                alert('Ошибка при проверке расписания тренера');
                return false;
            }
        }
    </script>
</body>

</html>